# 浏览器输入 URL 后发生了啥

## 输入地址

当我们开始在浏览器中输入网址时，浏览器其实就已经开始只能匹配 url，他会从历史记录、书签等地方，找到已经输入的字符串肯能对应的 url，然后智能提示，让你可以补全 url。对于 chrome 浏览器，他甚至可以直接从缓存中把页面展示出来，也就是说，你还没有按 enter，页面就出来了



## DNS 解析

DNS 解析的过程就是寻找哪台机器上有你需要的资源。当你在浏览器中输入一个地址时，如http://www.baidu.com，其实不是百度网站真正意义上的地址。互联网上每台计算机的唯一标识是它的 IP地址，但是 IP地址不方便记忆。用户更新换用方便记忆的网址去寻找互联网上的其他计算机，也就是上面提到的网址。所以互联网设计者需要在用户方便性与可用性方面做权衡，这个权衡就是一个网址到 IP地址的转换，这个过程就是 DNS 解析

**解析过程**：

1.  查找浏览器缓存：因为浏览器一般会缓存 DNS 记录一段时间，不同浏览器时间不同，如果有缓存，则直接返回 IP，否则下一步
2.  查找系统缓存：浏览器缓存找不到 IP 之后，浏览器会查看本地硬盘的 hosts 文件，看看其中有没有和这个域名对应的规则，如果有的话就直接使用 hosts 文件里面的 ip 地址
3.  如果在本地的 hosts 文件没有找到对应的 ip地址，浏览器会发送一个 DNS 请求到本地 DNS 服务器
4.  DNS 服务器接收到请求后，本地 DNS 服务器会首先递归查询自己的缓存记录，有缓存则直接返回，否则向根 DNS 服务器发送请求
5.  根 DNS 服务器没有记录具体的域名和 IP地址的对应关系，而是告诉 本地 DNS 服务器可以到域服务器上继续查询，并给出域服务器的地址，这个过程是迭代的过程
6.  本地 DNS 服务器继续向 域服务器发送请求，当前例子中是 .com域服务器。.com域服务器收到请求之后，也不会直接返回域名和 IP地址的对应关系，而是告诉本地 DNS 服务器，你的域名的解析服务器的地址
7.  最后，本地 DNS 服务器向解析服务器发送请求，这是能收到一个域名和 IP地址的对应关系，本地 DNS 服务器不仅把 IP 地址返回给用户电脑，还要把对应关系缓存起来



## 建立 TCP 连接

拿到域名对应的 IP 地址之后，会以随机端口（1024～65535）向 WEB 服务器程序 80端口发起 TCP 的连接请求，这个连接请求进入内核的 TCP / IP协议栈，还可能经过防火墙过滤，最终到达 Web 程序，最终建立 TCP / IP 连接

### 三次握手

1.  第一次握手：客户端将标志位 SYN 置为1，随意产生一个值为 seq=J（J 的取值范围为=1234567）的数据包到服务器，客户端进入 SYN_SENT 状态，等待服务端确认
2.  第二次握手：服务端收到数据包，服务端将标志位 SYN 和 ACK 都置为1，ack = J+1，随机产生一个值为seq = K并将该数据包发送给客户端以确认连接请求，服务端进入 SYN_RCVD 状态
3.  第三次握手：客户端收到确认后，检查 ack 是否为 J + 1，ACK 是否为1，如正确则将标志位 ACK 置为1，ack = K +1，并将该数据包发送给服务端，服务端检查 ack 是否为 K +1，ACK 是否为 1，如果正确则连接成功，完成三次握手



## 浏览器向 web 服务器发送一个 HTTP 请求

关键点：请求报文



## 服务器的永久重定向响应

服务器会给浏览器响应一个 301 永久重定向响应，这样浏览器就会访问 www.google.com/ 而非 google.com/



## 服务器处理请求

服务器从固定端口接收到 TCP 报文开始，它会对 TCP 连接进行处理，对 HTTP 协议进行解析，并按照报文格式进一步封装成 HTTP Request 对象，供上层使用

一般并发量大的网站，都会将同一个应用部署在多个服务器中，客户端第一时间请求反向代理服务器，再由代理服务器请求应用服务器



## 服务器返回一个 HTTP 响应

关键点：响应报文



## HTML解析

在浏览器没有完整接受全部 HTML 文档时，他就已经开始显示这个网页了

![浏览器渲染过程](https://user-gold-cdn.xitu.io/2020/1/3/16f6930bcc5b9338?imageslim)

![js 运行时](https://user-gold-cdn.xitu.io/2019/12/15/16f089bac9e42a95?imageslim)

当文档加载过程中遇到 js 文件时，html 文档会挂起渲染的线程。不仅需要等待文档中的 js 文件加载完毕，还要等待解析执行完毕，才可以恢复 html 文档的渲染线程。因为 js 有可能会修改 DOM，这意味着在 JS 执行完成前，后续所有资源的下载可能是没有必要的，这是 JS 阻塞后续资源下载的根本原因。

JS 解析由 JS complier（如 V8）完成，由于 JS 是单线程，所以同一时间只能做一件事情。所以任务分为同步任务和异步任务



## 断开连接

### 四次挥手

1.  第一次挥手：客户端发送一个 FIN，用来关闭客户端到服务端的数据传输，客户端进入 FIN_WAIT_1 状态
2.  第二次挥手：服务端收到 FIN，发送一个 ACK 给客户端，确认序号为收到序号 +1，服务端进入 CLOSE_WAIT 状态
3.  第三次挥手：服务端发送一个 FIN，用来关闭服务端到客户端的数据传输，服务端进入 LAST_ACK 状态
4.  第四次挥手：客户端收到 FIN 后，客户端进入 TIME_WAIT 状态，接着发送一个 ACK 给服务端，确认序号为收到收到序号 +1，服务端进入 CLOSED 状态，完成四次挥手
